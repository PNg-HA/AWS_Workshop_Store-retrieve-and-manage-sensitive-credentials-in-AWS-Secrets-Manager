<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.128.2">
    <meta name="description" content="">
<meta name="author" content="journeyoftheaverageguy@gmail.com">

    <link rel="icon" href="//localhost:1313/images/favicon.png" type="image/png">

    <title>Building your own automated response :: AWS System Manager</title>

    
    <link href="//localhost:1313/css/nucleus.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/fontawesome-all.min.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/hybrid.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/featherlight.min.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/perfect-scrollbar.min.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/auto-complete.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/atom-one-dark-reasonable.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/theme.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/hugo-theme.css?1722863950" rel="stylesheet">
    
    <link href="//localhost:1313/css/theme-workshop.css?1722863950" rel="stylesheet">
    
    

    <script src="//localhost:1313/js/jquery-3.3.1.min.js?1722863950"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="//localhost:1313/5/5.4/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="//localhost:1313/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="//localhost:1313/js/lunr.min.js?1722863950"></script>
<script type="text/javascript" src="//localhost:1313/js/auto-complete.js?1722863950"></script>
<script type="text/javascript">
    
        var baseurl = "\/\/localhost:1313\/";
    
</script>
<script type="text/javascript" src="//localhost:1313/js/search.js?1722863950"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/1-workshop-instructions/" title="Workshop Instructions" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/1-workshop-instructions/">
           <b> 1. </b> Workshop Instructions
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2/" title="Module-0: Environment Setup" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/2/">
          Module-0: Environment Setup
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/3/" title="Update Sample Application" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/3/">
           <b> Module-1 </b> Update Sample Application
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/3/3.1/" title="UUpdate Sample Application" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/3/3.1/">
           <b> Task-1.1: </b> UUpdate Sample Application
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/3/3.2/" title="Putting ABAC into Action" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/3/3.2/">
           <b> Task-1.2: </b> Putting ABAC into Action
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/4/" title="Monitor Compliance of Secrets" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/4/">
           <b> Module-2 </b> Monitor Compliance of Secrets
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/4/4.1/" title="Review AWS Config Rules for Secrets Manager" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/4/4.1/">
           <b> Task-2.1: </b> Review AWS Config Rules for Secrets Manager
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/4/4.2/" title="Create SNS Topic and Subscription for receiving notifications" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/4/4.2/">
           <b> Task-2.2: </b> Create SNS Topic and Subscription for receiving notifications
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/4/4.3/" title="Create Amazon EventBridge Event Rule" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/4/4.3/">
           <b> Task-2.3: </b> Create Amazon EventBridge Event Rule
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/4/4.4/" title="Enable Secret Rotation" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/4/4.4/">
           <b> Task-2.4: </b> Enable Secret Rotation
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/4/4.5/" title="Test Secret CMK Compliance" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/4/4.5/">
           <b> Task-2.5: </b> Test Secret CMK Compliance
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/5/" title="Automation of Incident Response Workflows" class="dd-item 
        parent
        
        
        ">
      <a href="//localhost:1313/5/">
           <b> Module-3: </b> Automation of Incident Response Workflows
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/5/5.1/" title="Setting up notifications" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/5/5.1/">
           <b> 5.1 </b> Setting up notifications
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/5/5.2/" title="Set up a weekly vulnerability summary email" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/5/5.2/">
           <b> 5.2 </b> Set up a weekly vulnerability summary email
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/5/5.3/" title="Automated Security Response on AWS" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/5/5.3/">
           <b> 5.3 </b> Automated Security Response on AWS
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/5/5.4/" title="Building your own automated response" class="dd-item 
        
        active
        
        ">
      <a href="//localhost:1313/5/5.4/">
           <b> 5.4 </b> Building your own automated response
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/5/5.5/" title="Enriching security findings with investigative data" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/5/5.5/">
           <b> 5.5 </b> Enriching security findings with investigative data
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/6-cleanup/" title="Clean up resources" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/6-cleanup/">
          <b>6. </b>Clean up resources
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj/"><i class='fab fa-facebook'></i> AWS Study Group</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="//localhost:1313/5/5.4/" selected>English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="//localhost:1313/vi/5/5.4/">Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title="Migrate" Alt="web counter"   border="0" /></a>  <br>
     <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" Alt="web counter"   border="0"   />
     
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>30-01-2022</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
           
            <i> <a href="https://www.linkedin.com/in/sutrinh/"  style="color:orange">Sử Trịnh  </a> <br>
                <a href="https://www.linkedin.com/in/jotaguy"  style="color:orange">Gia Hưng </a> <br>
                <a href="https://www.linkedin.com/in/hiepnguyendt"  style="color:orange">Thanh Hiệp </a>
               
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='//localhost:1313/'>Threat Detection & Response Workshop</a> > <a href='//localhost:1313/5/'>Automation of Incident Response Workflows</a> > Building your own automated response
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Building your own automated response
            </h1>
          

        



	
<div class="notices info" ><p><strong>Scenario / Problem Statement</strong>: Your manager has asked you to explore automation to remediate security findings starting with the types of findings that require the fastest time to remediation.</p>
</div>

<p>Unlike how you set up the notification earlier, you may not want fully automate responses to findings. To set up automation that you can manually trigger it for specific findings, you can use custom actions. A custom action is a Security Hub mechanism for sending selected findings to EventBridge that can be matched by an EventBridge rule. The rule defines a specific action to take when a finding is received that is associated with the custom action ID. Custom actions can be used, for example, to send a specific finding, or a small set of findings, to a response or remediation workflow. You can create up to 50 custom actions.</p>
<p>In this section, we will walk you through how to create a custom action in Security Hub which will trigger an EventBridge rule to execute a Lambda function. The purpose of the Lambda function will be to alter the Security Group for an EC2 instance. This is just an example of how to build your own automations. This example is not production ready.</p>
<h4 id="create-the-security-group">Create the Security Group</h4>
<ol>
<li>
<p>Navigate to the EC2 console and open the <a href="https://console.aws.amazon.com/ec2/home?#SecurityGroups">Security Groups page</a> using the navigation on the left.</p>
</li>
<li>
<p>Click <strong>Create Security Group</strong>. Here, you will set up the Security Group you want applied to the instance during incident response. You want to limit traffic to just what is neccessary to your corporate CIDR. Set the <strong>Security group name</strong> to &ldquo;IncidentResponseSG&rdquo; and give it a description.</p>
</li>
<li>
<p>Delete the VPC specified and select the VPC that shows &ldquo;<strong>cfn-GuardDutyLabs&hellip;</strong>&rdquo;.</p>
</li>
<li>
<p>Delete the outbound rule added by default.</p>
</li>
<li>
<p>Add 2 inbound rules so that your corporate CIDR can RDP and SSH to the instance. Follow the screenshot below.</p>
</li>
</ol>

<div class="notices warning" ><p>The CIDR blocks are just fake examples that would represent your corporate CIDR in order to allow your security team to RDP and SSH into the instance for forensics.</p>
</div>

<ol start="6">
<li>
<p>Save the Security Group by clicking <strong>Create Security Group</strong>.</p>
</li>
<li>
<p>Copy the Security group ID AND the VPC ID for your new security group. You will need these IDs to complete this module.
<img alt="VPC" src="//localhost:1313/images/5/5.4/s6a.png">
Result:
<img alt="VPC" src="//localhost:1313/images/5/5.4/s6b.png"></p>
</li>
</ol>
<h4 id="create-the-lambda-function">Create the Lambda function</h4>
<ol start="8">
<li>
<p>Let&rsquo;s create the Lambda function we will use to swap the security group on the instance. Go to <a href="https://console.aws.amazon.com/lambda/home?#/create/function?intent=authorFromScratch">https://console.aws.amazon.com/lambda/home?#/create/function?intent=authorFromScratch</a></p>
</li>
<li>
<p>On the <strong>Create function</strong> page, set the <strong>Function name</strong> to &ldquo;IR-ChangeInstanceSecurityGroup&rdquo; and pick <strong>Node.js 20.x</strong> for the <strong>Runtime</strong>.
<img alt="VPC" src="//localhost:1313/images/5/5.4/s9.png"></p>
</li>
<li>
<p>Click Create function.</p>
</li>
<li>
<p>Copy and paste the following code into the editor labeled <strong>Code source</strong> (removing the existing code). Replace the value for SecurityGroupId (currently set to &ldquo;sg-XXXXXXXXXXXX&rdquo;) with the security group ID you noted earlier.</p>
</li>
</ol>
<pre tabindex="0"><code>import { EC2Client, ModifyInstanceAttributeCommand } from &#34;@aws-sdk/client-ec2&#34;;
const ec2Client = new EC2Client();

export const handler = async (event, context) =&gt; {
  try {
    const findings = event.detail.findings;
    const SecurityGroupId = &#34;sg-XXXXXXXXXXXX&#34;;
    var instanceARN;
    if (findings &amp;&amp; findings.length &gt; 0){
        instanceARN = findings[0].Resources[0].Id;
    }
    
    const command = new ModifyInstanceAttributeCommand({
      InstanceId: instanceARN.split(&#39;/&#39;)[1],
      Groups: [SecurityGroupId]
    });

    await ec2Client.send(command);

    return &#39;Updated security group.&#39;;
  } catch (error) {
    console.error(&#39;Error:&#39;, error);
    throw error;
  }
};
</code></pre><ol start="12">
<li>Then from the <strong>Code source</strong> menu, click <strong>File</strong> then <strong>Save</strong>. Then click the <strong>Deploy</strong> button.
<img alt="VPC" src="//localhost:1313/images/5/5.4/s12.png"></li>
</ol>
<h4 id="update-lambda-function-permissions">Update Lambda function permissions</h4>
<ol start="13">
<li>
<p>Directly above the <strong>Code source</strong> section for the Lambda function you created, click the <strong>Configuration</strong> tab. Then click <strong>Permissions</strong> from the left navigation appears. We need to modify the execution role for this Lambda function.</p>
</li>
<li>
<p>Click the <strong>Role name</strong>. It should start with &ldquo;IR-ChangeInstanceSecurityGroup-role-&rdquo;. This will take you to the role in the Identity and Access Management (IAM) console.
<img alt="VPC" src="//localhost:1313/images/5/5.4/s14.png"></p>
</li>
<li>
<p>From the Role page, click the <strong>Add permissions</strong> button and select <strong>Create inline policy</strong>.</p>
</li>
<li>
<p>On the Create policy page, click the JSON tab. Then replace the existing policy with the following policy (do not use this policy in production, it does not follow least privilege).</p>
</li>
</ol>
<pre tabindex="0"><code>{
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Action&#34;: [
                &#34;ec2:*&#34;,
                &#34;ec2:Describe*&#34;,
                &#34;ec2:ModifyInstanceAttribute&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;
        }
    ]
}
</code></pre><ol start="17">
<li>
<p>Click the <strong>Next</strong> button. If you see a banner stating <strong>You need permissions</strong>, ignore it.</p>
</li>
<li>
<p>Give your policy the name &ldquo;ModifySG&rdquo; and click <strong>Create policy</strong>.
<img alt="VPC" src="//localhost:1313/images/5/5.4/s18.png"></p>
</li>
</ol>
<h4 id="create-a-custom-action-in-security-hub">Create a Custom Action in Security Hub</h4>
<ol start="19">
<li>
<p>Open Security Hub. Open the Custom actions page under <a href="https://us-east-1.console.aws.amazon.com/securityhub/home?region=us-east-1#/settings/actions">Management</a> in the navigation on the left.</p>
</li>
<li>
<p>Click the <strong>Create custom action</strong> button.</p>
</li>
<li>
<p>Enter an Action Name, Action Description, and an Action ID that are representative of an action that you are implementing, for example, &ldquo;UpdateSecurityGroup&rdquo;.</p>
</li>
<li>
<p>Click Create custom action.
<img alt="VPC" src="//localhost:1313/images/5/5.4/s22.png"></p>
</li>
</ol>
<p><img alt="VPC" src="//localhost:1313/images/5/5.4/s22b.png">
23. Copy the Custom action ARN that was generated. You will need the Custom ARN in the next steps.</p>
<h4 id="create-amazon-eventbridge-rule-to-capture-the-custom-action">Create Amazon EventBridge Rule to capture the Custom Action</h4>
<p>In this section, you will define an EventBridge rule that will match events (findings) coming from Security Hub which were forwarded by the custom action you defined above.</p>
<ol start="24">
<li>
<p>Navigate to the Amazon EventBridge console.</p>
</li>
<li>
<p>Click on the Create rule on the right side.</p>
</li>
<li>
<p>In the Define rule detail page give your rule a name and a description that represents the rule&rsquo;s purpose (for example, the same name and description you used for the custom action). Then click Next.</p>
</li>
<li>
<p>All Security Hub findings are sent as events to the AWS default event bus. The define pattern section allows you to identify filters to take a specific action when matched events appear. On the <strong>Build event pattern</strong> step, leave the <strong>Event source</strong> set to <strong>AWS events or EventBridge partner events</strong>.</p>
</li>
<li>
<p>Scroll down to Event pattern. Under E<strong>vent source</strong>, leave it set to <strong>AWS Services</strong>, and under AWS Service, select <strong>Security Hub</strong>.</p>
</li>
<li>
<p>For the <strong>Event Type</strong>, choose <strong>Security Hub Findings</strong> – <strong>Custom Action</strong>.</p>
</li>
<li>
<p>Then select the <strong>Specific custom action ARN(s)</strong> radio button and enter the ARN for the custom action that you created earlier.</p>
</li>
<li>
<p>Notice that as you selected these options, the Event pattern on the right was updating. Click <strong>Next</strong>.</p>
</li>
<li>
<p>On the <strong>Select target(s)</strong> step, select <strong>Lambda function</strong> from the <strong>Select a target</strong> dropdown. Then select <strong>IR-ChangeInstanceSecurityGroup</strong> from the <strong>Function</strong> dropdown.</p>
</li>
<li>
<p>Click <strong>Next</strong>.</p>
</li>
<li>
<p>On the <strong>Configure tags</strong> step, click <strong>Next</strong>.</p>
</li>
<li>
<p>On the <strong>Review and create</strong> step, click <strong>Create rule</strong>.
<img alt="VPC" src="//localhost:1313/images/5/5.4/s35.png"></p>
</li>
</ol>
<h4 id="trigger-the-automation">Trigger the automation</h4>
<ol start="36">
<li>
<p>Your automation is now setup. Let&rsquo;s test it on a finding for an EC2 instance. Return to the Findings page in Security Hub.</p>
</li>
<li>
<p>Add a filter for <strong>Resource Type</strong> and enter <strong>AwsEc2Instance</strong> (case sensitive). Click <strong>Apply</strong>.
<img alt="VPC" src="//localhost:1313/images/5/5.4/s37.png"></p>
</li>
<li>
<p>Add a another filter for <strong>EC2 Instance VPC ID</strong> and for input the VPC ID you noted when you created the Security Group at the start of this module. Click <strong>Apply</strong>.</p>
</li>
<li>
<p>Click the title of any finding in this filtered list where the resource shows the type <strong>AwsEc2Instance</strong>.</p>
</li>
<li>
<p>Before we trigger the automation, let&rsquo;s look at the current configuration the EC2 instance so that we can confirm our automation works. Expand <strong>Resources</strong> section of the finding.
<img alt="VPC" src="//localhost:1313/images/5/5.4/s40.png"></p>
</li>
<li>
<p>Click the blue link for this EC2 instance, under the heading <strong>Resource ID</strong>. This will open a new tab showing on the EC2 console showing only this EC2 instance.</p>
</li>
<li>
<p>Click the instance ID, and then click the <strong>Security</strong> tab. Take note of the name of the security group.
<img alt="VPC" src="//localhost:1313/images/5/5.4/s42.png"></p>
</li>
<li>
<p>Go back to the Security Hub tab in your browser (don&rsquo;t close out of the EC2 tab, you will need to return here) and click in the check box on the left side of this same finding.</p>
</li>
<li>
<p>In the <strong>Actions</strong> drop down choose the name of your custom action, Update <strong>SG</strong>.
<img alt="VPC" src="//localhost:1313/images/5/5.4/s44.png"></p>
</li>
<li>
<p>After seeing the banner display &ldquo;Successfully started action&hellip;&rdquo; go back to the EC2 browser tab. Refresh the tab (usually after 3 minutes). Verify that the security group on the instance has been changed.
<img alt="VPC" src="//localhost:1313/images/5/5.4/s45.png"></p>
</li>
</ol>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="//localhost:1313/5/5.3/" title="Automated Security Response on AWS"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="//localhost:1313/5/5.5/" title="Enriching security findings with investigative data" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="//localhost:1313/js/clipboard.min.js?1722863950"></script>
    <script src="//localhost:1313/js/perfect-scrollbar.min.js?1722863950"></script>
    <script src="//localhost:1313/js/perfect-scrollbar.jquery.min.js?1722863950"></script>
    <script src="//localhost:1313/js/jquery.sticky.js?1722863950"></script>
    <script src="//localhost:1313/js/featherlight.min.js?1722863950"></script>
    <script src="//localhost:1313/js/highlight.pack.js?1722863950"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="//localhost:1313/js/modernizr.custom-3.6.0.js?1722863950"></script>
    <script src="//localhost:1313/js/learn.js?1722863950"></script>
    <script src="//localhost:1313/js/hugo-learn.js?1722863950"></script>

    <link href="//localhost:1313/mermaid/mermaid.css?1722863950" rel="stylesheet" />
    <script src="//localhost:1313/mermaid/mermaid.js?1722863950"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>

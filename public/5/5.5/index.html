<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.128.2">
    <meta name="description" content="">
<meta name="author" content="journeyoftheaverageguy@gmail.com">

    <link rel="icon" href="//localhost:1313/images/favicon.png" type="image/png">

    <title>Enriching security findings with investigative data :: AWS System Manager</title>

    
    <link href="//localhost:1313/css/nucleus.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/fontawesome-all.min.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/hybrid.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/featherlight.min.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/perfect-scrollbar.min.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/auto-complete.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/atom-one-dark-reasonable.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/theme.css?1722863950" rel="stylesheet">
    <link href="//localhost:1313/css/hugo-theme.css?1722863950" rel="stylesheet">
    
    <link href="//localhost:1313/css/theme-workshop.css?1722863950" rel="stylesheet">
    
    

    <script src="//localhost:1313/js/jquery-3.3.1.min.js?1722863950"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="//localhost:1313/5/5.5/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="//localhost:1313/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="//localhost:1313/js/lunr.min.js?1722863950"></script>
<script type="text/javascript" src="//localhost:1313/js/auto-complete.js?1722863950"></script>
<script type="text/javascript">
    
        var baseurl = "\/\/localhost:1313\/";
    
</script>
<script type="text/javascript" src="//localhost:1313/js/search.js?1722863950"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/1-workshop-instructions/" title="Workshop Instructions" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/1-workshop-instructions/">
           <b> 1. </b> Workshop Instructions
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2/" title="Module-0: Environment Setup" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/2/">
          Module-0: Environment Setup
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/3/" title="Update Sample Application" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/3/">
           <b> Module-1 </b> Update Sample Application
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/3/3.1/" title="UUpdate Sample Application" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/3/3.1/">
           <b> Task-1.1: </b> UUpdate Sample Application
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/3/3.2/" title="Putting ABAC into Action" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/3/3.2/">
           <b> Task-1.2: </b> Putting ABAC into Action
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/4/" title="Monitor Compliance of Secrets" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/4/">
           <b> Module-2 </b> Monitor Compliance of Secrets
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/4/4.1/" title="Review AWS Config Rules for Secrets Manager" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/4/4.1/">
           <b> Task-2.1: </b> Review AWS Config Rules for Secrets Manager
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/4/4.2/" title="Create SNS Topic and Subscription for receiving notifications" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/4/4.2/">
           <b> Task-2.2: </b> Create SNS Topic and Subscription for receiving notifications
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/4/4.3/" title="Create Amazon EventBridge Event Rule" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/4/4.3/">
           <b> Task-2.3: </b> Create Amazon EventBridge Event Rule
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/4/4.4/" title="Enable Secret Rotation" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/4/4.4/">
           <b> Task-2.4: </b> Enable Secret Rotation
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/4/4.5/" title="Test Secret CMK Compliance" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/4/4.5/">
           <b> Task-2.5: </b> Test Secret CMK Compliance
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/5/" title="Automation of Incident Response Workflows" class="dd-item 
        parent
        
        
        ">
      <a href="//localhost:1313/5/">
           <b> Module-3: </b> Automation of Incident Response Workflows
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/5/5.1/" title="Setting up notifications" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/5/5.1/">
           <b> 5.1 </b> Setting up notifications
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/5/5.2/" title="Set up a weekly vulnerability summary email" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/5/5.2/">
           <b> 5.2 </b> Set up a weekly vulnerability summary email
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/5/5.3/" title="Automated Security Response on AWS" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/5/5.3/">
           <b> 5.3 </b> Automated Security Response on AWS
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/5/5.4/" title="Building your own automated response" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/5/5.4/">
           <b> 5.4 </b> Building your own automated response
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/5/5.5/" title="Enriching security findings with investigative data" class="dd-item 
        
        active
        
        ">
      <a href="//localhost:1313/5/5.5/">
           <b> 5.5 </b> Enriching security findings with investigative data
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/6-cleanup/" title="Clean up resources" class="dd-item 
        
        
        
        ">
      <a href="//localhost:1313/6-cleanup/">
          <b>6. </b>Clean up resources
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj/"><i class='fab fa-facebook'></i> AWS Study Group</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="//localhost:1313/5/5.5/" selected>English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="//localhost:1313/vi/5/5.5/">Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title="Migrate" Alt="web counter"   border="0" /></a>  <br>
     <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" Alt="web counter"   border="0"   />
     
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>30-01-2022</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
           
            <i> <a href="https://www.linkedin.com/in/sutrinh/"  style="color:orange">Sử Trịnh  </a> <br>
                <a href="https://www.linkedin.com/in/jotaguy"  style="color:orange">Gia Hưng </a> <br>
                <a href="https://www.linkedin.com/in/hiepnguyendt"  style="color:orange">Thanh Hiệp </a>
               
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='//localhost:1313/'>Threat Detection & Response Workshop</a> > <a href='//localhost:1313/5/'>Automation of Incident Response Workflows</a> > Enriching security findings with investigative data
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Enriching security findings with investigative data
            </h1>
          

        



	<p>In today&rsquo;s quickly evolving threat landscape, understanding risk and reaching the root cause of an issue in a timely manner is critical to businesses. Amazon Detective makes it easier to analyze, investigate, and quickly identify the root cause of potential security issues or suspicious activities. Amazon Detective supports the ability to automatically investigate AWS Identity and Access Management (IAM) entities for indicators of compromise (IoC). This capability helps security analysts determine whether IAM entities have potentially been compromised or involved in any known tactics, techniques, and procedures (TTP) from the MITRE ATT&amp;CK framework. You can programmatically use the Detective Investigation API to help investigate potential security issues.</p>
<p>Security Hub is a cloud security posture management tool that automatically detects when your AWS accounts and resources deviate from security best practices, aggregates security alerts into a single place and format, and understands your overall security posture across all of your AWS accounts. Security Hub gives you the option to send findings to another security solution, such as AWS Security Lake or an AWS Partner Network (APN) solution. Many customers leverage AWS Security Hub to detect security misconfigurations and to review and prioritize security findings. They prefer the simplified, centralized view of findings in Security Hub over reviewing and prioritizing findings in each of the services and regions they originate from.</p>
<p>Amazon GuardDuty is an intelligent threat detection service that continuously monitors your AWS accounts, workloads, runtime activity, and data for malicious activity. If potential malicious activity, such as anomalous behavior or credential exfiltration is detected, GuardDuty generates detailed security findings. Once you enable GuardDuty and Security Hub in the same account within the same AWS Region, GuardDuty starts sending all the generated findings to Security Hub.</p>
<p>In this module, you will build a solution that integrates Detective with Security Hub giving you better visibility into threat indicators and investigative data directly from Security Hub. This allows you to perform more timely investigations of GuardDuty findings from a centralized view. The solution will perform the enrichment automatically for high and medium severity findings and gives you the flexibility to initiate additional investigations and enrichment on-demand. By enriching findings in Security Hub, you have the option of reviewing those enriched finding directly in the Security Hub console, or you can enable an integration to review the enriched findings in your solution of choice.</p>
<h4 id="the-solution-architecture">The solution architecture</h4>
<p>Security Hub automatically sends all new findings and all updates to existing findings to EventBridge as Security Hub Findings - Imported events. Each Security Hub Findings - Imported event contains a single finding. Security Hub also sends findings that are associated with custom actions to EventBridge as Security Hub Findings - Custom Action events. As shown in the architecture diagram below, you will use EventBridge Rules to invoke a Lambda function for each finding you enrich. You will use an EventBridge Rule for Imported events to automatically initiate the Lambda function for high (and medium) severity findings that are aggregated by Security Hub from GuardDuty. You will use a second EventBridge Rule for Custom Action events to initiate additional investigations and enrichment on-demand. Both EventBridge Rules will target the same Lambda function. The Lambda function calls the Detective Investigation API, waits for the results, and then calls the Security Hub API to update the finding.</p>
<p><img alt="S3" src="//localhost:1313/images/5/5.5/arch-integration.png"></p>

<div class="notices info" ><p><strong>Scenario / Problem Statement</strong>: Since your team turned on various AWS security services and aggregated everything in Security Hub, your leadership is asking for insights from all that data. In particular, you have been asked to glean insights on compliance, highest priority alerts, and resources generating the highest number of security alerts.</p>
</div>

<h4 id="retrieve-investigative-data-from-detective-using-lambda">Retrieve investigative data from Detective using Lambda</h4>
<p>You can start investigations in Detective and retrieve the results via API. To do this, you will use a Lambda function written in JavaScript (Node.js 20.x). AWS Lambda supports several programming languages, but you will use JavaScript in this example.</p>
<p>To start an investigation, you must supply the API with an Amazon Resource Name (ARN) of an IAM role or user, start time, end time, and the ARN of the Detective behavior graph. The Detective API will fetch the results of the investigation including indicators of compromise, TTPs (tactics, techniques, and procedures), and a categorical severity score. The severity score returned is computed using two dimensions; confidence and impact; where the confidence represents likelihood the events are anomalous and not normal user behavior. The second dimension is the impact; which quantifies harm that could occur from the events as a measure of TTPs’ effect.</p>
<ol>
<li>
<p>First, create the Lambda function. Go to <a href="https://console.aws.amazon.com/lambda/home?#/create/function?intent=authorFromScratch">https://console.aws.amazon.com/lambda/home?#/create/function?intent=authorFromScratch</a> .</p>
</li>
<li>
<p>On the Create function page, set the Function name to &ldquo;InvestigateWithDetective&rdquo; and pick Node.js 20.x for the Runtime.</p>
</li>
<li>
<p>Leave all of the other settings as they are. Click Create function.</p>
</li>
<li>
<p>Copy and paste the following code into the editor labeled Code source. This will be the target of the EventBridge rule in the architecture. The function takes the ARN from a GuardDuty security finding aggregated by Security Hub, and calls the Investigation API. When the result is returned, the function formats the data into the AWS Security Finding Format (ASFF) used by Security Hub, and calls the BatchUpdateFindings API to send the enriched, updated finding back to Security Hub.</p>
</li>
</ol>
<pre tabindex="0"><code>&#34;use strict&#34;;
import {
  DetectiveClient,
  GetInvestigationCommand,
  ListGraphsCommand,
  StartInvestigationCommand,
} from &#34;@aws-sdk/client-detective&#34;;
import { BatchUpdateFindingsCommand, SecurityHubClient } from &#34;@aws-sdk/client-securityhub&#34;;

const SHClient = new SecurityHubClient();
const detectiveClient = new DetectiveClient();

export const handler = async (event) =&gt; {
  try {
    // Handle only one (the first) finding per function call
    const finding = event.detail.findings[0];

    if (finding.ProductName != &#34;GuardDuty&#34;) {
      // Handle only GuardDuty findings
      throw new Error(&#34;This is not a GuardDuty finding!&#34;);
    }

    const listgraphs = new ListGraphsCommand({});
    const graphs = await detectiveClient.send(listgraphs);
    const graphArn = graphs.GraphList[0].Arn;

    const IAMResourceARNs = finding.Resources.filter((resource) =&gt; {
      return (
        resource.Type == &#34;AwsIamRole&#34; ||
        resource.Type == &#34;AwsIamUser&#34; ||
        (resource.Type == &#34;AwsIamAccessKey&#34; &amp;&amp; resource.Details.AwsIamAccessKey.PrincipalName != &#34;aws:ec2-instance&#34;)
      );
    }).map((resource) =&gt; {
      if (resource.Type == &#34;AwsIamRole&#34; || resource.Type == &#34;AwsIamUser&#34;) {
        return {
          arn: resource.Id,
          type: resource.Type == &#34;AwsIamRole&#34; ? &#34;role&#34; : &#34;user&#34;,
        };
      } else if (resource.Type == &#34;AwsIamAccessKey&#34;) {
        return {
          arn: `arn:aws:iam::${finding.AwsAccountId}:role/${resource.Details.AwsIamAccessKey.PrincipalName}`,
          type: &#34;role&#34;,
        };
      }
    });

    if (IAMResourceARNs.length == 0) {
      throw new Error(&#34;No IAM resource to investigate!&#34;);
    }

    // Investigate the first IAM role or user identified in the finding
    const investigationTarget = IAMResourceARNs[0].arn;
    const investigationTargetType = IAMResourceARNs[0].type;

    const investigationEndTime = new Date(Date.now());
    investigationEndTime.setMinutes(investigationEndTime.getMinutes() - 5);

    let investigationStartTime;
    if (finding.FirstObservedAt) {
      investigationStartTime = new Date(finding.FirstObservedAt);
    } else if (finding.CreatedAt) {
      investigationStartTime = new Date(finding.CreatedAt);
    } else if (finding.ProcessedAt) {
      investigationStartTime = new Date(finding.ProcessedAt);
    } else {
      throw new Error(&#34;Investigation start time invalid!&#34;);
    }
    investigationStartTime.setHours(investigationStartTime.getHours() - 24);

    const totalInvestigationTime = Math.round(
      (investigationEndTime.getTime() - investigationStartTime.getTime()) / (1000 * 60 * 60),
    ); // Hours

    const startInvestigationRequest = {
      GraphArn: graphArn,
      EntityArn: investigationTarget,
      ScopeStartTime: investigationStartTime,
      ScopeEndTime: investigationEndTime,
    };

    const startinvestigation = new StartInvestigationCommand(startInvestigationRequest);
    const investigation = await detectiveClient.send(startinvestigation);
    const investigationId = investigation.InvestigationId;

    const getInvestigationRequest = {
      GraphArn: graphArn,
      InvestigationId: investigationId,
    };

    let investigationResult = { Status: &#34;RUNNING&#34; };
    while (investigationResult.Status == &#34;RUNNING&#34;) {
      await new Promise((r) =&gt; setTimeout(r, 30000));
      const getinvestigation = new GetInvestigationCommand(getInvestigationRequest);
      investigationResult = await detectiveClient.send(getinvestigation);
      if (investigationResult.Status == &#34;FAILED&#34;) {
        throw new Error(&#34;Detective investigation failed!&#34;);
      }
    }

    let investigationSummary = &#34;&#34;;
    switch (investigationResult.Severity) {
      case &#34;INFORMATIONAL&#34;:
      case &#34;LOW&#34;:
        investigationSummary += `We did not observe uncommon behavior for the associated ${investigationTargetType} during the ${totalInvestigationTime} hour investigation window.`;
        break;
      case &#34;MEDIUM&#34;:
        investigationSummary += `We observed anomalous behavior for the associated ${investigationTargetType} during the ${totalInvestigationTime} hour investigation window which might be indicative of compromise.`;
        break;
      case &#34;HIGH&#34;:
      case &#34;CRITICAL&#34;:
        investigationSummary += `We observed anomalous behavior for the associated ${investigationTargetType} during the ${totalInvestigationTime} hour investigation window indicating potential compromise.`;
        break;
      default:
        throw new Error(&#34;Severity information not found!&#34;);
    }

    investigationSummary += &#34; For more information, visit &#34;;
    investigationSummary += `https://${process.env.AWS_REGION}.console.aws.amazon.com/detective/home?region=${process.env.AWS_REGION}#investigationReport/${investigationResult.InvestigationId}`;

    const findingUpdateInput = {
      FindingIdentifiers: [
        {
          Id: finding.Id,
          ProductArn: finding.ProductArn,
        },
      ],
      Note: {
        Text: investigationSummary.substring(0, 512),
        UpdatedBy: &#34;Detective Investigation Lambda function.&#34;,
      },
      UserDefinedFields: {
        investigate: &#34;complete&#34;,
      },
    };

    const batchUpdateCommand = new BatchUpdateFindingsCommand(findingUpdateInput);
    const updatedFinding = await SHClient.send(batchUpdateCommand);

    return updatedFinding;
  } catch (error) {
    console.error(&#34;Error:&#34;, error);
    throw error;
  }
};
</code></pre><ol start="5">
<li>
<p>Then from the Code source menu, click File then Save.</p>
</li>
<li>
<p>Then click the Deploy button.</p>
</li>
<li>
<p>Above the Code source section for the Lambda function you created, click the Configuration tab.</p>
</li>
<li>
<p>On the General Configuration tab, click Edit.</p>
</li>
<li>
<p>The timeout of the function needs to be extended to a 15-minute timeout to allow Detective to complete the investigation. Update the timeout to be 15 minutes and click Save.</p>
</li>
<li>
<p>Directly above the Code source section for the Lambda function you created, click the Configuration tab.</p>
</li>
<li>
<p>For this function to work as desired, you will need to change the permissions function. The permissions need to include the necessary actions you are taking with Detective and Security Hub in the function. You need to add a new policy to the execution role for this Lambda function. Then click Permissions from the left navigation appears.</p>
</li>
<li>
<p>Click the Role name. It should start with &ldquo;InvestigateWithDetective-role-&rdquo;. This will take you to the role in the Identity and Access Management (IAM) console.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s12.png"></p>
</li>
<li>
<p>From the Role page, click the Add permissions button and select Create inline policy.</p>
</li>
<li>
<p>On the Create policy page, click the JSON tab. Then replace the existing policy with the following policy (do not use this policy in production, it does not quite follow least privilege and is meant as an example).</p>
</li>
</ol>
<pre tabindex="0"><code>{
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: [
                &#34;detective:ListGraphs&#34;,
                &#34;detective:searchGraph&#34;,
                &#34;detective:StartInvestigation&#34;,
                &#34;detective:UpdateInvestigationState&#34;,
                &#34;detective:GetInvestigation&#34;,
                &#34;detective:ListInvestigations&#34;,
                &#34;detective:ListIndicators&#34;,
                &#34;securityhub:BatchUpdateFindings&#34;,
                &#34;securityhub:UpdateFindings&#34;
            ],
            &#34;Resource&#34;: &#34;*&#34;
        }
    ]
}
</code></pre><ol start="15">
<li>
<p>Click the Next button. If you see a banner stating You need permissions, ignore it.</p>
</li>
<li>
<p>Give your policy the name &ldquo;DetectiveSecurityHubIntegration&rdquo; and click Create policy.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s16.png"></p>
</li>
</ol>
<h4 id="set-up-automated-investigations-and-finding-enrichment-with-easy-to-configure-filters">Set up automated investigations and finding enrichment with easy to configure filters</h4>
<p>Now that you have GuardDuty, Security Hub, and Detective enabled (this was done for you) and have set up the Lambda function, you are ready to set up the two methods of initiating the investigations. The first approach involves automatically investigating and enriching HIGH and MEDIUM severity GuardDuty findings. This will accelerate investigations for the highest severity findings because you don’t need to go into Security Hub or Detective and manually select the findings for investigation.</p>
<p>In this approach, you will initiate the Lambda function you previously set up by using Security Hub Automations and an EventBridge Rule. Using Security Hub Automations allows you to configure and update what findings get automatically investigated and enriched without ongoing code changes (automation rules use a UI with dropdown options for criteria).</p>
<ol start="17">
<li>
<p>Open Security Hub and go to the <a href="https://us-east-1.console.aws.amazon.com/securityhub/home?region=us-east-1#/automation-rule">Automations page</a>.</p>
</li>
<li>
<p>Click Create rule.</p>
</li>
<li>
<p>Select Create custom rule.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s19.png"></p>
</li>
<li>
<p>Name your rule &ldquo;Automated Investigation&rdquo; and give the rule a description.</p>
</li>
<li>
<p>Under Criteria, select ProductName for Key, Equals for Operator, and input &ldquo;GuardDuty&rdquo; for Value.</p>
</li>
<li>
<p>Click Add criteria.</p>
</li>
<li>
<p>For the second criteria, select SeverityLabel for Key, Equals for Operator, and HIGH for Value.</p>
</li>
<li>
<p>Then under that criteria, click the text, Add another value. This time select Equals for Operator and MEDIUM for Value.</p>
</li>
<li>
<p>Click Add criteria a third time. This time, select ResourceType for Key, Equals for Operator, and input &ldquo;AwsIamAccessKey&rdquo; for Value (case-sensitive).</p>
</li>
<li>
<p>Under the ResourceType criteria, click Add another value twice to add two more values. Use the operator Equals for both. Then use the Values &ldquo;AwsIamUser&rdquo; and &ldquo;AwsIamRole&rdquo;, respectively. Make sure the Criteria section matches the screenshot below.</p>
</li>
</ol>
<p>(Index by workshop, not mistake)</p>
<ol start="26">
<li>
<p>Scroll down to the Automated action section and click Add another key-value pair. This is how you will set a user-defined field to flag findings you want automatically investigated.</p>
</li>
<li>
<p>For the Key, input &ldquo;investigate&rdquo;, and for the Value, input &ldquo;true&rdquo;. Leave all of the other field as they are.</p>
</li>
<li>
<p>At the bottom of the page, click Create rule.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s28.png"></p>
</li>
<li>
<p>Next, you need to set an EventBridge Rule to determine which findings are investigated based on the user-defined field, you can use a single rule in Amazon EventBridge. In this case, the EventBridge Rule will look for Security Hub Findings – Imported. Each Security Hub Findings - Imported event contains a single finding. However, you only want to match findings that contain the user-defined field, &ldquo;investigate&rdquo;. Navigate to <a href="https://us-east-1.console.aws.amazon.com/events/home?region=us-east-1#/">EventBridge</a>.</p>
</li>
<li>
<p>Click Create rule under Get started (with EventBridge Rule selected).</p>
</li>
<li>
<p>On the Define rule detail page, give your rule a name and description. For Name, input &ldquo;AutomatedInvestigation&rdquo;. Then click Next.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s31.png"></p>
</li>
<li>
<p>On the Build event pattern step, scroll down to Event pattern. Select the method Custom pattern (JSON editor).
Copy and paste the following JSON into the Event pattern field.</p>
</li>
</ol>
<pre tabindex="0"><code>{
  &#34;source&#34;: [&#34;aws.securityhub&#34;],
  &#34;detail&#34;: {
    &#34;findings&#34;: {
      &#34;UserDefinedFields&#34;: {
        &#34;investigate&#34;: [&#34;true&#34;]
      }
    }
  }
}
</code></pre><ol start="34">
<li>
<p>Click Next.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s34.png"></p>
</li>
<li>
<p>On the Select target(s) step, select Lambda function from the Select a target dropdown. Then select InvestigateWithDetective from the Function dropdown.</p>
</li>
<li>
<p>Click Next.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s36.png"></p>
</li>
<li>
<p>On the Configure tags step, click Next.</p>
</li>
<li>
<p>On the Review and create step, click Create rule. As new findings are aggregated in Security Hub, they will be evaluated and updated by the automation rule. Any that receive the user-defined field will initiate the Lambda function. After initiating the Lambda, it can take a couple minutes for the execution to complete and appear in Security Hub.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s38.png"></p>
</li>
</ol>

<div class="notices warning" ><p><strong>Note to Participants</strong>: It may be awhile before a finding is updated or created, which would initiate this automation. Move on with the instructions for now. In the next section, you will set up an process for initiating finding investigation and enrichment on-demand.</p>
</div>

<h4 id="set-up-on-demand-finding-investigation-and-enrichment">Set up on-demand finding investigation and enrichment</h4>
<p>The second approach involves investigating and enriching findings on-demand. You may want both approaches in case there are findings that don’t meet the criteria of your earlier automation that you still want to investigate.</p>
<ol start="39">
<li>
<p>In this approach, you will initiate the same Lambda function through the use of a feature in Security Hub called Custom Actions. Open Security Hub and go to the <a href="https://us-east-1.console.aws.amazon.com/securityhub/home?region=us-east-1#/settings/actions">Custom actions page</a>.</p>
</li>
<li>
<p>Click Create custom action.</p>
</li>
<li>
<p>For Action name input &ldquo;Investigate&rdquo;. For Action Description input &ldquo;Investigate with Detective&rdquo; For Action ID input &ldquo;investigate&rdquo;.</p>
</li>
<li>
<p>Click Create custom action.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s42.png"></p>
</li>
<li>
<p>Copy the Custom action ARN that was generated for your custom finding. You will need this in a few steps.</p>
</li>
<li>
<p>Next, you will need to create another rule in EventBridge, but this time it will match events for your custom action. Navigate to <a href="https://us-east-1.console.aws.amazon.com/events/home?region=us-east-1#/">EventBridge</a>.</p>
</li>
<li>
<p>Click Create rule under Get started (with EventBridge Rule selected).</p>
</li>
<li>
<p>On the Define rule detail page, give your rule a name and description. For Name, input &ldquo;InitiatedAutomatedInvestigation&rdquo;. Then click Next.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s46.png"></p>
</li>
<li>
<p>On the Build event pattern step, scroll down to Event Pattern. Leave the Event source set to AWS Services. Scroll down to Event pattern. Under Event source, select Security Hub.</p>
</li>
<li>
<p>For the Event Type, choose Security Hub Findings – Custom Action.</p>
</li>
<li>
<p>Then select the Specific custom action ARN(s) radio button and input the ARN for the custom action that you created earlier.</p>
</li>
<li>
<p>Click Next.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s50.png"></p>
</li>
<li>
<p>On the Select target(s) step, select Lambda function from the Select a target dropdown. Then select InvestigateWithDetective from the Function dropdown.</p>
</li>
<li>
<p>Click Next.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s52.png"></p>
</li>
<li>
<p>On the Configure tags step, click Next.</p>
</li>
<li>
<p>On the Review and create step, click Create rule.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s54.png"></p>
</li>
</ol>
<h4 id="initiate-an-on-demand-finding-investigation">Initiate an on-demand finding investigation</h4>
<ol start="55">
<li>
<p>Return to Security Hub. Open the Findings page.</p>
</li>
<li>
<p>In the Add filter input, add a filter for Resource Type. Set the filter to Resource Type is AwsIamAccessKey (case sensitive). Click Apply.</p>
</li>
<li>
<p>In the Add filter input, add a filter for Product Name. Set the filter to Product Name is GuardDuty (case sensitive). Click Apply.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s56.png"></p>
</li>
<li>
<p>Click the title of the a finding in the list and check if there are any Notes present. If there are, expand the section and see what the notes are (if present, can you tell where the note came from?). Note:
<img alt="VPC" src="//localhost:1313/images/5/5.5/s57.png"></p>
</li>
<li>
<p>Do not select the finding regarding RegisterManagedInstance.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s58.png"></p>
</li>
<li>
<p>Click the check box to the left of this same finding to select it.</p>
</li>
<li>
<p>In the Actions dropdown, select your new custom action (Investigate).
<img alt="VPC" src="//localhost:1313/images/5/5.5/s60.png">
Choose another finding to investigate:
<img alt="VPC" src="//localhost:1313/images/5/5.5/s60b.png">
After 3 minutes:
<img alt="VPC" src="//localhost:1313/images/5/5.5/s60c.png"></p>
</li>
<li>
<p>This may take up to 15 minutes for the investigation to complete. Refresh the page every couple minutes until the finding has a new Notes section in the details. Click the title of the same finding and expand the Notes section.
Waiting after 5 minutes to see the node update:
<img alt="VPC" src="//localhost:1313/images/5/5.5/s61.png"></p>
</li>
<li>
<p>You can also toggle to the History tab in the finding details to see the timestamped event with the Note change.</p>
</li>
</ol>
<h4 id="surface-investigated-findings-in-a-custom-insight">Surface investigated findings in a custom insight</h4>
<ol start="63">
<li>
<p>If you want to easilly track resources and findings that have been investigated through either of the approaches you implemented, create a new custom insight in Security Hub. Open Security Hub and go to the <a href="https://us-east-1.console.aws.amazon.com/securityhub/home?region=us-east-1#/insights">Insights page</a>.</p>
</li>
<li>
<p>Click Create insight.</p>
</li>
<li>
<p>Click the field that states &ldquo;Add filter&rdquo; at the top of the page and select User defined fields.</p>
</li>
<li>
<p>Set Key to investigate and Value to complete. This will filter the list of findings to only those that were successfully enriched. Click Apply.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s66.png">
Result:
<img alt="VPC" src="//localhost:1313/images/5/5.5/s66b.png"></p>
</li>
<li>
<p>Click the field that states &ldquo;Add filter&rdquo; at the top of the page again and select GroupBy. Then pick Resource ID. Click Apply.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s67.png"></p>
</li>
<li>
<p>The insight is now showing a list of resources and a count of how many active, associated findings are investigated and enriched.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s68.png"></p>
</li>
<li>
<p>Click Create insight. Name your insight &ldquo;Investigated Resources&rdquo; and click Create insight again.
<img alt="VPC" src="//localhost:1313/images/5/5.5/s69.png"></p>
</li>
<li>
<p>At the top of the page, click Insight details to see the graphs for the new insight.</p>
</li>
</ol>
<p><img alt="VPC" src="//localhost:1313/images/5/5.5/s70.png"></p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="//localhost:1313/5/5.4/" title="Building your own automated response"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="//localhost:1313/6-cleanup/" title="Clean up resources" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="//localhost:1313/js/clipboard.min.js?1722863950"></script>
    <script src="//localhost:1313/js/perfect-scrollbar.min.js?1722863950"></script>
    <script src="//localhost:1313/js/perfect-scrollbar.jquery.min.js?1722863950"></script>
    <script src="//localhost:1313/js/jquery.sticky.js?1722863950"></script>
    <script src="//localhost:1313/js/featherlight.min.js?1722863950"></script>
    <script src="//localhost:1313/js/highlight.pack.js?1722863950"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="//localhost:1313/js/modernizr.custom-3.6.0.js?1722863950"></script>
    <script src="//localhost:1313/js/learn.js?1722863950"></script>
    <script src="//localhost:1313/js/hugo-learn.js?1722863950"></script>

    <link href="//localhost:1313/mermaid/mermaid.css?1722863950" rel="stylesheet" />
    <script src="//localhost:1313/mermaid/mermaid.js?1722863950"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
